name: Archive Feeds
on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch: {}

jobs:
  pull:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install httpx python-dateutil
      - name: Pull feeds
        env:
          AIRNOW_API_KEY: ${{ secrets.AIRNOW_API_KEY }}
          PURPLEAIR_API_KEY: ${{ secrets.PURPLEAIR_API_KEY }}
          AQICN_API_KEY: ${{ secrets.AQICN_API_KEY }}
          METRO_API_KEY: ${{ secrets.METRO_API_KEY }}
          METRO_VEHICLE_POS_URL: ${{ secrets.METRO_VEHICLE_POS_URL }}
          METRO_TRIP_UPDATES_URL: ${{ secrets.METRO_TRIP_UPDATES_URL }}
        run: |
          python - <<'PY'
          import os, json, pathlib, httpx
          from datetime import datetime, timezone

          def dump(name, data):
              ts = datetime.now(timezone.utc).strftime('%Y%m%dT%H%M%SZ')
              outdir = pathlib.Path('data')/name
              outdir.mkdir(parents=True, exist_ok=True)
              with open(outdir/(ts+'.json'), 'w') as f:
                  json.dump(data, f)

          async def jget(url, headers=None, params=None):
              async with httpx.AsyncClient(timeout=30) as c:
                  r = await c.get(url, headers=headers or {}, params=params or {})
                  r.raise_for_status()
                  try:
                      return r.json()
                  except Exception:
                      return {"raw": r.text}

          import asyncio
          async def main():
              base = 'https://traffic.houstontranstar.org/api'
              for path in ['incidents_sample.json','laneclosures_sample.json','roadwayfloodwarning_sample.json','speedsegments_sample.json']:
                  dump('transtar_'+path.split('_')[0], await jget(f"{base}/{path}"))

              dump('nws_alerts', await jget('https://api.weather.gov/alerts/active/area/TX'))

              dump('openaq_houston', await jget('https://api.openaq.org/v3/latest?city=Houston'))

              key = os.environ.get('AIRNOW_API_KEY')
              if key:
                  dump('airnow_77002', await jget('https://www.airnowapi.org/aq/observation/zipCode/current/', params={
                      'format':'application/json','zipCode':'77002','distance':25,'API_KEY':key
                  }))

              pkey = os.environ.get('PURPLEAIR_API_KEY')
              if pkey:
                  dump('purpleair_sample', await jget('https://api.purpleair.com/v1/sensors', headers={'X-API-Key':pkey}, params={'fields':'name,latitude,longitude,pm2.5_atm','max_age':600,'limit':50}))

              dump('usgs_sites', await jget('https://api.waterdata.usgs.gov/ogcapi/v0/collections/monitoring-locations/items?f=json&state=US:TX&county=US:48201'))

              async with httpx.AsyncClient(timeout=30) as c:
                  r = await c.get('https://www.ndbc.noaa.gov/data/latest_obs/42035.txt'); r.raise_for_status()
                  dump('ndbc_42035', { 'raw': r.text })

              vurl = os.environ.get('METRO_VEHICLE_POS_URL'); turl = os.environ.get('METRO_TRIP_UPDATES_URL'); key = os.environ.get('METRO_API_KEY')
              headers={'Ocp-Apim-Subscription-Key': key} if key else {}
              if vurl:
                  async with httpx.AsyncClient(timeout=30) as c:
                      r = await c.get(vurl, headers=headers); r.raise_for_status(); dump('metro_vehicle_positions', {'protobuf_hex': r.content.hex()})
              if turl:
                  async with httpx.AsyncClient(timeout=30) as c:
                      r = await c.get(turl, headers=headers); r.raise_for_status(); dump('metro_trip_updates', {'protobuf_hex': r.content.hex()})
          asyncio.run(main())
          PY
      - name: Commit
        run: |
          git config user.name 'github-actions'
          git config user.email 'actions@users.noreply.github.com'
          git add -A
          git commit -m "chore(data): archive feeds" || echo "nothing to commit"
          git push
